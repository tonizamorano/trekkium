<?php
/**
 * Registrar campos meta para usuarios con rol guia
 */
add_action('show_user_profile', 'mostrar_campos_usuario_personalizados');
add_action('edit_user_profile', 'mostrar_campos_usuario_personalizados');
add_action('user_new_form', 'mostrar_campos_usuario_personalizados');

function mostrar_campos_usuario_personalizados($user) {
    // Solo mostrar para roles guia
    $user_id = isset($user->ID) ? $user->ID : 0;
    $user_roles = $user->roles ?? (isset($_POST['role']) ? array($_POST['role']) : array());
    
    if (!$user_id && isset($_POST['role'])) {
        $user_roles = array($_POST['role']);
    }
    
    if (!array_intersect($user_roles, array('guia'))) {
        return;
    }
    
    // Obtener valores actuales
    $sobre_mi = get_user_meta($user_id, 'sobre_mi', true);
    $comunidad_autonoma = get_user_meta($user_id, 'comunidad_autonoma', true);
    
    // Nonce para seguridad
    wp_nonce_field('datos_profesionales_nonce', 'datos_profesionales_nonce_field');
    ?>
    
    <h2>Datos profesionales</h2>
    <table class="form-table">
        <!-- Sobre mí -->
        <tr>
            <th><label for="sobre_mi">Sobre mí</label></th>
            <td>
                <?php
                $settings = array(
                    'textarea_name' => 'sobre_mi',
                    'textarea_rows' => 10,
                    'teeny' => false,
                    'media_buttons' => false,
                    'tinymce' => array(
                    'toolbar1' => 'bold,italic,underline,bullist,numlist,blockquote,alignleft,aligncenter,alignright,link,unlink,undo,redo',
                    ),
                );
                wp_editor($sobre_mi, 'sobre_mi_editor', $settings);
                ?>
            </td>
        </tr>
        
        <!-- Comunidad autónoma (solo lectura) -->
        <tr>
            <th><label for="comunidad_autonoma">Comunidad autónoma</label></th>
            <td>
                <input type="text" 
                       id="comunidad_autonoma" 
                       name="comunidad_autonoma_display" 
                       value="<?php echo esc_attr($comunidad_autonoma); ?>" 
                       readonly 
                       style="background-color: #f5f5f5; border: 1px solid #ddd; padding: 8px; color: #666; width: 100%;"
                >
                <p class="description">Calculado automáticamente según la provincia o país</p>
                <input type="hidden" name="comunidad_autonoma" value="<?php echo esc_attr($comunidad_autonoma); ?>">
            </td>
        </tr>
    </table>
    
    <!-- CSS inline para mejorar la apariencia -->
    <style>
        .wp-editor-container {
            border: 1px solid #ccd0d4;
        }
        .mce-toolbar .mce-btn-group {
            margin: 2px;
        }
    </style>
    <?php
}

/**
 * Guardar campos meta del usuario
 */
add_action('personal_options_update', 'guardar_campos_usuario_personalizados');
add_action('edit_user_profile_update', 'guardar_campos_usuario_personalizados');
add_action('user_register', 'guardar_campos_usuario_personalizados');

function guardar_campos_usuario_personalizados($user_id) {
    if (!current_user_can('edit_user', $user_id)) return false;
    
    // Verificar nonce
    if (!isset($_POST['datos_profesionales_nonce_field']) || 
        !wp_verify_nonce($_POST['datos_profesionales_nonce_field'], 'datos_profesionales_nonce')) {
        return;
    }
    
    $user = get_userdata($user_id);
    if (!$user || !array_intersect($user->roles, array('guia'))) return;
    
    // Guardar solo "sobre mí"
    if (isset($_POST['sobre_mi'])) {
        update_user_meta($user_id, 'sobre_mi', wp_kses_post($_POST['sobre_mi']));
    }
}

/**
 * Autorrellenar campo "comunidad_autonoma" según provincia o país
 */
add_action('profile_update', 'autofill_comunidad_autonoma', 20, 2);
add_action('user_register', 'autofill_comunidad_autonoma', 20, 1);

function autofill_comunidad_autonoma($user_id, $old_user_data = null) {
    $user = get_userdata($user_id);
    if (!$user || !array_intersect((array)$user->roles, array('guia'))) return;

    $billing_country = get_user_meta($user_id, 'billing_country', true);
    if (empty($billing_country)) return;

    if ($billing_country !== 'ES') {
        if (class_exists('WC_Countries')) {
            $countries = new WC_Countries();
            $country_name = $countries->countries[$billing_country] ?? $billing_country;
        } else {
            $country_name = $billing_country;
        }
        update_user_meta($user_id, 'comunidad_autonoma', $country_name);
        return;
    }

    $billing_state = get_user_meta($user_id, 'billing_state', true);
    if (empty($billing_state)) return;

    $map = array(
        'AL'=>'Andalucía','CA'=>'Andalucía','CO'=>'Andalucía','GR'=>'Andalucía','HU'=>'Aragón','JA'=>'Andalucía',
        'MA'=>'Andalucía','SE'=>'Andalucía','TE'=>'Aragón','Z'=>'Aragón','O'=>'Asturias','PM'=>'Illes Balears',
        'GC'=>'Canarias','TF'=>'Canarias','S'=>'Cantabria','AV'=>'Castilla y León','BU'=>'Castilla y León','LE'=>'Castilla y León',
        'P'=>'Castilla y León','SA'=>'Castilla y León','SG'=>'Castilla y León','SO'=>'Castilla y León','VA'=>'Castilla y León','ZA'=>'Castilla y León',
        'AB'=>'Castilla-La Mancha','CR'=>'Castilla-La Mancha','CU'=>'Castilla-La Mancha','GU'=>'Castilla-La Mancha','TO'=>'Castilla-La Mancha',
        'B'=>'Catalunya','GI'=>'Catalunya','L'=>'Catalunya','T'=>'Catalunya','CE'=>'Ceuta',
        'A'=>'Comunidad Valenciana','CS'=>'Comunidad Valenciana','V'=>'Comunidad Valenciana',
        'BA'=>'Extremadura','CC'=>'Extremadura','C'=>'Galicia','LU'=>'Galicia','OR'=>'Galicia','PO'=>'Galicia',
        'M'=>'Madrid','ML'=>'Melilla','MU'=>'Murcia','NA'=>'Navarra',
        'BI'=>'Euskadi','SS'=>'Euskadi','VI'=>'Euskadi','LO'=>'La Rioja',
    );

    if (isset($map[$billing_state])) {
        update_user_meta($user_id, 'comunidad_autonoma', $map[$billing_state]);
    }
}

/**
 * Funciones helper para obtener los datos
 */
function get_usuario_sobre_mi($user_id = null) {
    if (!$user_id) $user_id = get_current_user_id();
    return get_user_meta($user_id, 'sobre_mi', true);
}

function get_usuario_comunidad_autonoma($user_id = null) {
    if (!$user_id) $user_id = get_current_user_id();
    return get_user_meta($user_id, 'comunidad_autonoma', true);
}
